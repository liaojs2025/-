# 逐笔复现盘口：SQL到Pandas逐行回放的方案总结

日期：2026-01-29

## 1. 背景与结论
- 目标：基于逐笔委托/成交（stock_base.zb）复现快照盘口（stock_base.tk）
- 结论：**仅用 SQL 的“底账-消耗”框架无法准确处理 `type=1` 市价单与 `type=U` 本方最优单**，这些订单在事件驱动过程中依赖“当时盘口最优价”。因此改用 **Pandas 逐行回放**，通过维护“有效订单簿”和“价格层级字典”来动态更新盘口。

## 2. 数据与字段要点
### 2.1 快照（tk）
- 盘口字段：`bid1..bid10` / `ask1..ask10`，对应量为 `bidv1..bidv10` / `askv1..askv10`。

### 2.2 逐笔（zb）
- 关键字段：`price`、`volume`、`side`、`type`、`trade_flag`、`seqno`、`cbidno`、`caskno`。
- 事件识别（经验规则）：
  - 限价单：`type='2'` 且 `trade_flag` 为空。
  - 市价单：`type='1'` 且 `trade_flag` 为空，`price=0`。
  - 本方最优：`type='U'` 且 `trade_flag` 为空。
  - 成交：`trade_flag='F'`。
  - 撤单：`trade_flag='4'`。

## 3. SQL 方案的局限
SQL 方案采用“限价底账 + 成交/撤单消耗”的思路：
1. **limit_orders**：取 `type='2'` 作为底账。
2. **consumptions**：对 `trade_flag='F'/'4'` 按 `cbidno/caskno` 累计消耗。
3. **resting_vol**：`orig_vol - total_used`，按价位聚合成盘口。

问题：
- **`type=1` 市价单与 `type=U` 本方最优单** 的成交价格依赖当时盘口最优价，而 SQL 无法在“静态集合”里动态计算。
- 因此 SQL 方案只能作为粗略基线，难以达到可用精度。

## 4. Pandas 逐行回放方案（核心）
### 4.1 维护的状态
- `active_orders`：有效订单字典，键为 `seqno`，值包含 `price/vol/side`。
- `price_levels`：价格层级字典，分别维护买盘与卖盘的累积量。

### 4.2 处理规则
- **限价单（type=2）**：直接挂入 `price_levels`。
- **本方最优（type=U）**：
  - 买单取当前最高买价；卖单取当前最低卖价。
- **对手方最优/市价单（type=1）**：
  - 若有价格，用该价格；否则买单取最低卖价、卖单取最高买价。
- **成交（trade_flag='F'）**：按 `cbidno/caskno` 回溯原委托，减少订单量与价位挂单量。
- **撤单（trade_flag='4'）**：同样按 `cbidno/caskno` 减少挂单量。

### 4.3 关键实现特点
- 逐行扫描 `zb`，按 `seqno` 排序。
- 动态维护“最优买/卖价”，保证 `type=1/U` 能找到当时盘口最优价。
- 最终在 `target_time` 前生成盘口，并取前 10 档对比 tk。

## 5. 校验方法与指标
- 对比口径：买卖各 10 档，共 40 个字段（价/量）。
- 准确率：
  $$accuracy = \frac{matched}{40} \times 100\%$$
- 支持单标的单时刻验证，也支持批量抽样与全量深交所股票验证。

## 6. 常见问题与修复
- `bidv/askv` 列名需使用正确字段，不是 `bidvol/askvol`。
- `trade_flag/type` 可能是 bytes/字符串混合，需统一清洗或 `toString`。
- `cbidno/caskno` 是成交/撤单追踪原始订单的关键字段。

## 7. Observation 补充要点
### 7.1 字段与数据特性
- `time_int` 通常为当日毫秒时间戳；`date_time` 带时区。
- `exg` 为交易所标识（需结合数据字典确认深交所/上交所编码）。
- tk 为 3 秒间隔快照，逐笔为事件流。

### 7.2 竞价与交叉现象
- `09:25` 集合竞价阶段可能出现大量 `trade_flag='F'`。
- 实测在 09:30 附近出现“买一 > 卖一”的短暂交叉：
  - 建议按毫秒批处理再输出盘口（延迟检查）。
  - 识别“激进单”（限价单紧随成交），避免其短暂驻留。

### 7.3 异常申报与监管规则
- 存在“异常限价单”（如卖单价格显著偏离合理区间），可能触发即时撤单/暂存逻辑。
- 需参考深交所规则与技术通知：
  - 《深圳证券交易所交易规则（2023年修订）》
  - 《关于股票发行注册制改革相关市场技术准备安排的通知》
  - 《深交所程序化交易管理实施细则（2024年修订）》

## 8. 后续改进方向
- **激进单识别**：同毫秒内立即成交的限价单应视为“等效市价单”，不进入驻留盘口。
- **事件批处理**：同一毫秒内事件应先聚合，再输出盘口，减少短暂交叉误判。
- **交易阶段隔离**：若严格区分集合竞价与连续竞价，可进一步提升准确率。

## 9. V2 最终测试结果（2025-09-30 11:30:00）
运行结果：

```
测试完成!
深交所股票总数: 2867
跳过(无zb数据): 0
跳过(无tk数据): 0
有效测试股票数: 2867

正确率分布:
  100%正确: 2861 只
  90%-100%: 0 只
  80%-90%: 0 只
  <80%: 6 只

总体正确率: 114570/114680 = 99.90%

正确率最低的10只股票:
        股票代码  正确字段  总字段      正确率
1840  300394    20   40   50.00%
1281  002829    20   40   50.00%
953   002466    20   40   50.00%
2152  300718    21   40   52.50%
1584  300115    21   40   52.50%
2618  301227    28   40   70.00%
2840  301602    40   40  100.00%
2841  301603    40   40  100.00%
2842  301606    40   40  100.00%
2843  301607    40   40  100.00%
```

## 10. 相关文件
- SQL 方案 Notebook（不准确）：week1_tk_calc/v_1_tk_calc_bySQL.ipynb
- Pandas 方案 Notebook：week1_tk_calc/v_2_tk_calc_modify_byPandas.ipynb
